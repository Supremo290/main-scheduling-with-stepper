<!-- REMOVED: Term & School Year selector - now in date-picker -->

<!-- Display Selected Term & Year (Read-only) -->
<div *ngIf="activeTerm" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
  <div style="display: flex; align-items: center; gap: 10px;">
    <mat-icon style="color: #1565C0;">info</mat-icon>
    <div>
      <strong style="color: #0D47A1;">Selected Term & School Year:</strong>
      <span style="margin-left: 10px; font-size: 16px;">{{ getTermYearLabel(activeTerm) }}</span>
    </div>
  </div>
  <div style="margin-top: 10px;" *ngIf="selectedDates.length > 0">
    <strong style="color: #0D47A1;">Exam Dates:</strong>
    <mat-chip-list style="display: inline-flex; margin-left: 10px;">
      <mat-chip *ngFor="let d of selectedDates">
        {{ d | date: 'mediumDate' }}
      </mat-chip>
    </mat-chip-list>
  </div>
</div>

<!-- NEXT BUTTON -->
<div style="text-align: center; margin-bottom: 20px;">
  <button
    mat-raised-button
    color="accent"
    (click)="goNext()"
    [disabled]="!activeTerm || selectedDates.length === 0"
  >
    Load Student Mapping Table
  </button>
</div>


<button
  mat-raised-button
  color="accent"
  (click)="autoAssignSchedule()"
  [disabled]="!activeTerm || selectedDates.length === 0 || !showTable"
  style="margin-left: 10px;"
>
  <mat-icon>auto_fix_high</mat-icon>
  Auto-Assign Schedule
</button>

<!-- TABLE SECTION -->
<div
  class="p-4"
  *ngIf="showTable"
  style="background:#fff; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.1);"
>
  <h2 style="color:#0D47A1; font-weight:600; margin-bottom: 15px;">
    Student Mapping
  </h2>

  <mat-tab-group>
    <mat-tab
      *ngFor="let day of selectedDates; let i = index"
      [label]="'Day ' + (i + 1)"
    >
      <div style="margin-top: 20px; overflow-x: auto;">
        <h3 style="color:#1565C0;">Schedule for {{ day | date: 'fullDate' }}</h3>

        <table
          border="1"
          cellspacing="0"
          cellpadding="8"
          style="width:100%; border-collapse: collapse; text-align: left;"
        >
          <thead style="background-color: #1565C0; color: white;">
            <tr>
              <th>Program (Year)</th>
              <th *ngFor="let slot of daysWithTimeSlots[day]">{{ slot }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prog of programs">
              <td>
                <b>{{ prog.program }}</b> - Year {{ prog.year }}<br />
                <small
                  [style.color]="
                    getRemainingSubjectsConsideringAllDays(prog) === 0
                      ? 'green'
                      : 'red'
                  "
                >
                  Remaining:
                  {{ getRemainingSubjectsConsideringAllDays(prog) }}
                </small>
              </td>

              <td *ngFor="let slot of daysWithTimeSlots[day]">
                <select
                  [(ngModel)]="prog.schedule[day + '_' + slot]"
                  (focus)="capturePrev(prog, day + '_' + slot)"
                  (change)="onSubjectSelect(prog, slot, day)"
                  style="width: 160px; padding: 5px;"
                >
                  <option value=""></option>
                  <option
                    *ngFor="let subj of getAvailableSubjects(prog, day + '_' + slot)"
                    [value]="subj.subjectId"
                  >
                    {{ subj.subjectId }} - {{ subj.subjectTitle }}
                  </option>
                </select>

                <!-- âœ… Display code count under selected subject -->
                <div 
                  *ngIf="prog.schedule[day + '_' + slot]" 
                  style="font-size: 11px; color: #666; margin-top: 4px; padding: 2px 5px; background: #f0f0f0; border-radius: 3px; display: inline-block;"
                >
                  <mat-icon style="font-size: 12px; height: 12px; width: 12px; vertical-align: middle; color: #1565C0;">group</mat-icon>
                  <span style="margin-left: 3px;">
                    {{ getCodeCount(prog, prog.schedule[day + '_' + slot]) }} 
                    {{ getCodeCount(prog, prog.schedule[day + '_' + slot]) === 1 ? 'code' : 'codes' }}
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </mat-tab>
  </mat-tab-group>

  <div style="text-align:center; margin-top: 20px;">
    <button
      mat-raised-button
      color="primary"
      (click)="saveSchedule()"
      style="padding: 10px 25px;"
    >
      <mat-icon>save</mat-icon>
      Save Schedule
    </button>
  </div>
</div>